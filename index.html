<html>
  
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>    
    <script src="map.js"></script>

    <style>
      .scrollable-menu {
        height: auto;
        max-height: 300px;
        overflow-x: hidden;
      }
    </style>
  </head>
  
  <body>

    <!-- navigation bar at top -->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">TriMet Real-Time Vehicle Location</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Foo</a></li>
            <li><a href="#">Bar</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- body -->
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 main">
        <!-- TODO replace these breaks with css on body -->
          <br><br><br><br>
          
          <!-- dropdown filters -->
          <table>
            <tr>
              <td style="padding-right:1em">
                <strong>Route:</strong>
              </td>
              <td>
                <div class="btn-group" role="form">
                  <button id="line_btn" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  All    <span class="caret"></span>
                  </button>
                  <ul id="filter_line" class="dropdown-menu scrollable-menu" role="menu">
                    <li role="presentation" class="dropdown-header">Route</li>
                    <li role="presentation"><a href="#">All</a></li>
                    <li role="presentation" class="divider"></li>    
                  </ul>
                </div>
              </td>
            </tr>
            <tr>
              <td style="padding-right:1em">
                <strong>Direction:</strong>
              </td>
              <td>
                <div class="btn-group">
                  <button id="dir_btn" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  All    <span class="caret"></span>
                  </button>
                  <ul id="filter_dir" class="dropdown-menu scrollable-menu" role="menu">
                    <li role="presentation" class="dropdown-header">Direction</li>
                    <li role="presentation"><a href="#">All</a></li>
                    <li role="presentation" class="divider"></li>    
                    <li><a href="#">Inbound</a></li>
                    <li><a href="#">Outbound</a></li>
                  </ul>
                </div>
              </td>
            </tr>
          </table>

          <br>

          <!-- leaflet map -->
          <div id="map" style="width:100%; height:70vh"></div>
        </div>
      </div>
    </div>

    <script>

      //api constant variables
      var APPID = "59E23608FABA109B7153953F2";
      var BASE_URL = "http://developer.trimet.org/ws";
      var WS_VEH = "v2/vehicles";
      var WS_ROUTES = "V1/routeConfig";


      var map = new Map();
      map.initmap("map");
      var routes = {};


      function updateVehicles(route) {
          var url = BASE_URL + "/" + WS_VEH;
          var params = {appID:APPID};
          if(route !== null) {
              params["routes"] = route;
          }

          console.log(params);
          $.getJSON(url, params ,function(data) {
              console.log(data);
              
              //TODO handle if error was returned from api 
              map.clearVehicles();
              
              if(data.resultSet.hasOwnProperty('vehicle')) {
                  for(var i = 0; i < data.resultSet.vehicle.length; i++) {
                      map.addVehicle(data.resultSet.vehicle[i]);
                  }
              }
              else {
                  alert("No vehicle locations available for that route");
              }
          });
      }

      updateVehicles(null);
      

      //add routes trimet is publishing data for to dropdown filter
      //and add on click listener to update vehicles
      //for route user selects

      $.getJSON(BASE_URL + "/" + WS_ROUTES, {appID:APPID, json:true} ,function(data) {
          routesList = data.resultSet.route;
          
          for(var i = 0; i < routesList.length; i++) {
              var desc = routesList[i].desc;
              var rte = routesList[i].route;
              
              //use description as key to route number
              //this is used to retrieve route number for api call
              routes[desc] = rte; 
              
              //add each route to dropdown list
              $('#filter_line').append(
                  "<li><a href=\"#\">"+desc+"</a></li>"
              );
          }

          //each time a route is selected from dropdown make call
          //to api with that route as a param
          $('#filter_line a').on('click', function() {
              var line = this.text;

              //display selected line description as button text
              $("#line_btn").text(line+' ').append('<span class="caret"></span>');
             
              //update vehicle markers
              updateVehicles(routes[line]);
          });
      });

    </script>
  
  </body>

</html>
